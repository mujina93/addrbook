da addrbook: pip uninstall addrbook
poi: pip install -e .
Ho disinstallato l'app e reinstallata in modalità development
Nuovo metodo export() con decorator @expose('json') che viene chiamato dal nuovo bottone export JSON dalla pagina principale, tramite un download attribute in un elemento <a>

Runno python3.6 setup.py nosetests e ottengo ancora l'errore sul manager:

/*******************************************************/
running nosetests
running egg_info
writing addrbook.egg-info/PKG-INFO
writing dependency_links to addrbook.egg-info/dependency_links.txt
writing entry points to addrbook.egg-info/entry_points.txt
writing requirements to addrbook.egg-info/requires.txt
writing top-level names to addrbook.egg-info/top_level.txt
reading manifest file 'addrbook.egg-info/SOURCES.txt'
reading manifest template 'MANIFEST.in'
writing manifest file 'addrbook.egg-info/SOURCES.txt'
Searching for coverage
Best match: coverage 4.4.2
Processing coverage-4.4.2-py3.6.egg

Using /home/mujina/prog/Python/addrbook/.eggs/coverage-4.4.2-py3.6.egg
Wrong password keeps user_name in login form ... ok
Anonymous users are forced to login ... ok
Logouts must work correctly ... ok
Voluntary logins must work correctly ... ok
The data display demo works with HTML ... ok
The data display demo works with JSON ... ok
Displaying the wsgi environ works ... ok
The front page is working properly ... ok
Anonymous users must not access the secure controller ... ok
The editor cannot access the secure controller ... ok
The manager can access the secure controller ... ERROR
Model objects can be created ... ok
Model objects can be queried ... ok
Model objects can be created ... ok
Model objects can be queried ... ok
Model objects can be created ... ok
Users should be fetcheable by their email addresses ... ok
User objects should have no permission by default. ... ok
The obj constructor must set the email right ... ok
The obj constructor must set the user name right ... ok
Model objects can be queried ... ok

======================================================================
ERROR: The manager can access the secure controller
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/nose/case.py", line 198, in runTest
    self.test(*self.arg)
  File "/home/mujina/prog/Python/addrbook/addrbook/tests/functional/test_root.py", line 60, in test_secc_with_manager
    resp = self.app.get('/secc', extra_environ=environ, status=200)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/webtest/app.py", line 759, in get
    expect_errors=expect_errors)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/webtest/app.py", line 1121, in do_request
    self._check_status(status, res)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/webtest/app.py", line 1160, in _check_status
    "Bad response: %s (not %s)", res_status, status)
webtest.app.AppError: Bad response: 500 Internal Server Error (not 200)
-------------------- >> begin captured stdout << ---------------------
Running setup_app() from addrbook.websetup
Creating tables
Initializing Migrations

--------------------- >> end captured stdout << ----------------------
-------------------- >> begin captured logging << --------------------
tg.configuration.app_config: DEBUG: Initializing configuration, package: 'addrbook'
tg.configuration.milestones: DEBUG: config_ready milestone reached
tg.configuration.milestones: DEBUG: renderers_ready milestone reached
tg.configuration.milestones: DEBUG: environment_loaded milestone reached
tg.appwrappers.i18n: DEBUG: i18n enabled: True -> {'enabled': True, 'lang_session_key': 'tg_lang', 'no_session_touch': False, 'lang': None}
tg.appwrappers.identity: DEBUG: Identity enabled: True -> {'enabled': True, 'allow_missing_user': False, 'authmetadata': <addrbook.config.app_cfg.ApplicationAuthMetadata object at 0x7fdb723d8c50>}
tg.appwrappers.session: DEBUG: Sessions enabled: True -> {'invalidate_corrupt': True, 'type': 'cookie', 'data_dir': '/home/mujina/prog/Python/addrbook/data/sessions', 'key': 'addrbook', 'timeout': None, 'secret': 'f354e2b5-f619-49a7-9960-ce8b35da84c4', 'log_file': None, 'data_serializer': 'json', 'validate_key': 'f354e2b5-f619-49a7-9960-ce8b35da84c4'}
tg.appwrappers.caching: DEBUG: Caching enabled: True -> {'type': 'memory', 'data_dir': '/home/mujina/prog/Python/addrbook/data/cache', 'expire': None, 'log_file': None}
tg.appwrappers.mingflush: DEBUG: MingSessionFlush enabled: False -> {'autoflush': False}
tg.appwrappers.transaction_manager: DEBUG: TransactionManager enabled: True -> {'enabled': True, 'attempts': 1, 'commit_veto': None}
tg.appwrappers.errorpage: DEBUG: ErrorPageApplicationWrapper enabled: True -> {'enabled': True, 'status_codes': [403, 404], 'handle_exceptions': True, 'path': '/error/document', 'content_types': ['text/html', None]}
tg.configuration.app_config: DEBUG: Initializing configuration, package: 'addrbook'
tg.configuration.milestones: DEBUG: config_ready milestone reached
tg.configuration.milestones: DEBUG: renderers_ready milestone reached
tg.configuration.milestones: DEBUG: environment_loaded milestone reached
txn.140580572292864: DEBUG: new transaction
txn.140580572292864: DEBUG: commit
alembic.runtime.migration: INFO: Context impl SQLiteImpl.
alembic.runtime.migration: INFO: Will assume non-transactional DDL.
txn.140580572292864: DEBUG: new transaction
txn.140580572292864: DEBUG: commit <zope.sqlalchemy.datamanager.SessionDataManager object at 0x7fdb7061de80>
txn.140580572292864: DEBUG: commit
auth: INFO: request classification: browser
auth: INFO: -- repoze.who request started (/secc) --
auth: DEBUG: identifier plugins registered: [<tg.configuration.auth.setup._AuthenticationForgerPlugin object at 0x7fdb7043fd68>, <FastFormPlugin:/login_handler 140580458527096>, <AuthTktCookiePlugin 140580458528272>]
auth: DEBUG: identifier plugins matched for classification "browser": [<tg.configuration.auth.setup._AuthenticationForgerPlugin object at 0x7fdb7043fd68>, <FastFormPlugin:/login_handler 140580458527096>, <AuthTktCookiePlugin 140580458528272>]
auth: DEBUG: identity returned from <tg.configuration.auth.setup._AuthenticationForgerPlugin object at 0x7fdb7043fd68>: {'fake-userid': 'manager'}
auth: DEBUG: no identity returned from <FastFormPlugin:/login_handler 140580458527096> (None)
auth: DEBUG: no identity returned from <AuthTktCookiePlugin 140580458528272> (None)
auth: DEBUG: identities found: [(<tg.configuration.auth.setup._AuthenticationForgerPlugin object at 0x7fdb7043fd68>, {'fake-userid': 'manager'})]
auth: DEBUG: authenticator plugins registered: [<tg.configuration.auth.setup._AuthenticationForgerPlugin object at 0x7fdb7043fd68>]
auth: DEBUG: authenticator plugins matched for classification "browser": [<tg.configuration.auth.setup._AuthenticationForgerPlugin object at 0x7fdb7043fd68>]
auth: DEBUG: userid returned from <tg.configuration.auth.setup._AuthenticationForgerPlugin object at 0x7fdb7043fd68>: "manager"
auth: DEBUG: identities authenticated: [((0, 0), <tg.configuration.auth.setup._AuthenticationForgerPlugin object at 0x7fdb7043fd68>, <tg.configuration.auth.setup._AuthenticationForgerPlugin object at 0x7fdb7043fd68>, {'repoze.who.userid': 'manager'}, 'manager')]
tg.appwrappers.transaction_manager: DEBUG: Attempts Left 0 (1 total)
txn.140580572292864: DEBUG: new transaction
tg.appwrappers.transaction_manager: DEBUG: Error while running request, aborting transaction
txn.140580572292864: DEBUG: abort
tg.appwrappers.errorpage: DEBUG: ErrorPageApplicationWrapper response: /secc -> 500 @ text/html
tg.appwrappers.errorpage: DEBUG: ErrorPageApplicationWrapper serving <addrbook.controllers.root.RootController object at 0x7fdb704e5dd8>:/error/document
tg.appwrappers.transaction_manager: DEBUG: Attempts Left 0 (1 total)
txn.140580572292864: DEBUG: new transaction
txn.140580572292864: DEBUG: commit <zope.sqlalchemy.datamanager.SessionDataManager object at 0x7fdb703e7748>
txn.140580572292864: DEBUG: commit
tg.appwrappers.transaction_manager: DEBUG: Transaction committed!
auth: INFO: no challenge required
auth: INFO: -- repoze.who request ended (/secc) --
backlash: DEBUG: Traceback (most recent call last):
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/_compat.py", line 87, in reraise
    raise value
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/appwrappers/transaction_manager.py", line 79, in __call__
    response = self.next_handler(controller, environ, context)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/appwrappers/caching.py", line 54, in __call__
    return self.next_handler(controller, environ, context)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/appwrappers/session.py", line 71, in __call__
    response = self.next_handler(controller, environ, context)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/appwrappers/identity.py", line 75, in __call__
    return self.next_handler(controller, environ, context)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/appwrappers/i18n.py", line 71, in __call__
    return self.next_handler(controller, environ, context)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/wsgiapp.py", line 285, in _dispatch
    return controller(environ, context)
  File "/home/mujina/prog/Python/addrbook/addrbook/lib/base.py", line 27, in __call__
    return TGController.__call__(self, environ, context)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/controllers/dispatcher.py", line 119, in __call__
    response = self._perform_call(context)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/controllers/dispatcher.py", line 108, in _perform_call
    r = self._call(action, params, remainder=remainder, context=context)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/controllers/decoratedcontroller.py", line 125, in _call
    response = self._render_response(context, controller, output)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/controllers/decoratedcontroller.py", line 235, in _render_response
    template_name=template_name, **render_params)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/render.py", line 208, in render
    kwargs['result'] = render_function(template_name, tg_vars, **kwargs)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/renderers/kajiki.py", line 98, in __call__
    cache_expire=cache_expire)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/render.py", line 274, in cached_template
    return render_func()
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/tg/renderers/kajiki.py", line 94, in render_template
    return Markup(template(template_vars).render())
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/kajiki/template.py", line 105, in render
    return ''.join(self)
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/kajiki/template.py", line 100, in __iter__
    for chunk in self.__main__():
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/kajiki/util.py", line 79, in __iter__
    for xx in x:
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/kajiki/util.py", line 79, in __iter__
    for xx in x:
  File "/home/mujina/prog/Python/tg2py3.6env/lib/python3.6/site-packages/kajiki/util.py", line 77, in __iter__
    for x in self.iterator:
  File "/home/mujina/prog/Python/addrbook/addrbook/templates/index.xhtml", line 26, in _kj_block_body
    <h1>Hey ${user}</h1>
NameError: name 'user' is not defined
tg.support.middlewares: DEBUG: Removing DBSession from current thread
--------------------- >> end captured logging << ---------------------

----------------------------------------------------------------------
Ran 21 tests in 2.756s

FAILED (errors=1)
/*****************************************************/

Provato a mettere un try sul test test_root.py/test_secc_with_manager() ma nulla da fare.
Scopro in controllers/secure.py un altro controller, diverso da root.py, che ha bisogno di implementare le funzioni (ad esempio index nel modo giusto, così da passare i parametri alla pagina index.xhtml)
Modificato la funzione index per il SecureController, in modo da non mostrare dati
Ora i test standard con nosetests funzionano e non danno problemi (ho tolto anche il try/except da test_secc_with_manager)

Aggiunto i test per aggiunta, visualizzazione contatti, e cancellazione contatti.
